var doc=document,html=$("html"),body=$(doc.body),win=window,appPath="_System/apps/bcpie-bcpie/",settingsPath=appPath+"scripts/settings.json",oauthTokenAPI="https://framework-bcpie.rhcloud.com/api/git-token",frameworkName="",frameworkUserName="",frameworkRepository="";$(function(){var e={ui:{showLoading:function(){body.find("#pagecontainer").addClass("hide"),html.addClass("loading")},hideLoading:function(){body.find("#pagecontainer").removeClass("hide"),html.removeClass("loading")}},updateBCPie:function(){function t(){$.ajax({type:"GET",url:oauthTokenAPI,success:function(t){$.setGithubSetOAuthToken(t.token),$.getGithubFileByFilePath(p.registry.username,p.registry.repo,p.registry.filename,function(t){h=JSON.parse(t);var i="";frameworkName=h.repos[0].name,frameworkUserName=h.repos[0].username,frameworkRepository=h.repos[0].repository,a(),e.checkAppUpdate(p.registry.currentVersion,p.registry.lastVersion)}),e.ui.hideLoading()}})}function a(){e.ui.showLoading();var t=frameworkRepository,a=frameworkUserName;$.getGithubFileByFilePath(a,t,"repo2.json",function(t){m=JSON.parse(t),treeData=[],treeData=o(m),r(treeData),l.removeClass("hide"),e.ui.hideLoading()})}function o(e){for(var t in e.structure)for(var a=e.structure[t],i=0;i<a.length;i++){var o={title:a[i].name,isFolder:"folder"==a[i].type?!0:!1,key:t+"/"+a[i].name};o.children=[];var r=a[i].files;if(a[i].hasOwnProperty("files"))for(var n=0;n<r.length;n++){var s={title:r[n].name,key:t+"/"+a[i].name+"/"+r[n].name,isFolder:"folder"==r[n].type?!0:!1};if("folder"==r[n].type){s.children=[];for(var d=r[n].files,p=0;p<d.length;p++){var l={title:d[p].name,key:t+"/"+a[i].name+"/"+r[n].name+"/"+d[p].name};s.children.push(l)}}o.children.push(s)}treeData.push(o)}return treeData}function r(e){var t=!0,a=$.grep(e,function(e){return e.key.indexOf("bcpieLayoutsApp/")>-1});try{body.find("#updateTree").dynatree("getTree")}catch(i){t=!1}if(t){var o=body.find("#updateTree").dynatree("getRoot");o.removeChildren(),o.addChild(e)}else body.find("#updateTree").dynatree({checkbox:!0,selectMode:3,children:a,onSelect:function(e,t){var a=$.map(t.tree.getSelectedNodes(),function(e){return e.data.key});$("#echoSelection3").text(a.join(", "));var i=t.tree.getSelectedNodes(!0),o=$.map(i,function(e){return e.data.key});$("#echoSelectionRootKeys3").text(o.join(", ")),$("#echoSelectionRoots3").text(i.join(", "))},onDblClick:function(e,t){e.toggleSelect()},onKeydown:function(e,t){return 32==t.which?(e.toggleSelect(),!1):void 0},cookieId:"dynatree-Cb3",idPrefix:"dynatree-Cb3-"}),$("#updateTree").dynatree("getRoot").visit(function(e){e.select(!0)})}function n(){u.on("change",function(){"1"===$(this).val()?f.find("ul li input").prop("checked",!0):f.find("ul li input").prop("checked",!1)})}function s(){var e="";for(i=0;i<p.folders.length;i++){var t=p.folders[i];for(e=e+"<h4>"+t.rootfolder+"</h4>",e+='<ul class="small-block-grid-2 medium-block-grid-3 large-block-grid-4">',j=0;j<t.subfolders.length;j++){var a=new Date(t.subfolders[j].lastUpdated),o=a.getDate()+"/"+(a.getMonth()+1)+"/"+a.getFullYear();e=e+'<li><input type="checkbox" name="folders" value="'+t.rootfolder+"/"+t.subfolders[j].name+'" data-rootfolder="'+i+'"  data-subfolder="'+j+'"/><span data-tooltip aria-haspopup="true" class="has-tip" data-options="show_on:large" title="Last Updated on '+a+'">'+t.subfolders[j].name+"</span></li>"}e+='<li><input type="checkbox" name="folders" value="Layouts/Test" data-rootfolder="0" data-subfolder="17">',e+='<span data-tooltip="" aria-haspopup="true" class="has-tip" data-options="show_on:large" title="Last Updated on Wed Feb 25 2015 17:01:06 GMT+0530 (India Standard Time)">WebApps</span>',e+='<ul ><li><input type="checkbox" name="folders" value="Layouts/Test/1"/>1</li>',e+='<li><input type="checkbox" name="folders" value="Layouts/Test/2"/>2</li>',e+="<ul>",e+="</li>",e+="</ul>"}f.append(e)}var d=body.find("#pagecontent"),p=$.parseJSON(bcpie.api.file.get(settingsPath)),l=body.find("#folderContainer"),c=body.find('[name="frameworks"]'),u=body.find('[name="folderSelect"]'),f=body.find("#foldersListContainer"),h,y,m;t(),n()},appUpdate:function(t,a){$('input[name="btnUpdateApp"]').on("click",function(){$("#divUpdate").addClass("hide"),e.ui.showLoading();var i=$.parseJSON(bcpie.api.file.get(settingsPath)),o=[];o=$.map($("#updateTree").dynatree("getSelectedNodes"),function(e){return e.childList?void 0:e.data.key});var r=0,n=function(t){var a=o[t].replace("bcpieLayoutsApp/","");a="bcpieLayoutsApp/_System/Apps/bcpie-layouts/"+a;var i=a;i=i.replace("bcpieLayoutsApp/",""),i=i.replace("bcpie-layouts","bcpie-bcpie"),$.getGithubFileByFilePath(frameworkUserName,frameworkRepository,a,function(e){bcpie.api.file.save(i,e).done(function(){window.clearTimeout(),$.sticky("<b>App Updated Successfully</b>",{closeImage:"/_system/apps/bcpie-bcpie/images/close.png"})})}),t++,t<o.length?n(t):e.ui.hideLoading()};n(r),setTimeout(function(){i.registry.currentVersion=t,i.registry.lastVersion=a,bcpie.api.file.save(settingsPath,JSON.stringify(i)),e.ui.hideLoading()},3e3)})},checkAppUpdate:function(t,a){var i=t,o="bcpieLayoutsApp/_System/Apps/bcpie-layouts/scripts/settings.json";$.getGithubFileByFilePath(frameworkUserName,frameworkRepository,o,function(t){var a=JSON.parse(t),o=a.registry.currentVersion,r=a.registry.lastVersion;i!=o&&(e.appUpdate(o,r),$("#divUpdate").removeClass("hide"))})}};e.updateBCPie()});